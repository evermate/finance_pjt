commit ebd0822d85a160e78342170c08b12b5dfb4b147e
Author: kwakseoh <kwakseoh@naver.com>
Date:   Fri May 23 17:07:58 2025 +0900

    feat: ì¶”ì²œ ì‹œìŠ¤í…œ í”„ë¡œí† íƒ€ì… ë“œë¡­ë‹¤ìš´ êµ¬í˜„

diff --git a/backend/products/views.py b/backend/products/views.py
index 63eaafa..bac7ab1 100644
--- a/backend/products/views.py
+++ b/backend/products/views.py
@@ -1,57 +1,107 @@
-from rest_framework import viewsets
+# products/views.py
+
+from datetime import date
+
+from rest_framework import viewsets, filters
 from rest_framework.decorators import action
 from rest_framework.response import Response
 from rest_framework.pagination import PageNumberPagination
-from django.db.models import Prefetch, OuterRef, Subquery, FloatField
-from rest_framework.permissions import AllowAny
+from rest_framework.permissions import IsAuthenticated
+from rest_framework.authentication import TokenAuthentication
+from django.db.models import OuterRef, Subquery, FloatField
 
 from .models import Bank, DepositProduct, InterestOption
 from .serializers import BankSerializer, DepositProductSerializer, InterestOptionSerializer
 
 
-# ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
+# â”€â”€â”€ ê¸°ë³¸ í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 class StandardResultsPagination(PageNumberPagination):
-    page_size = 10
+    page_size = 10  # í•œ í˜ì´ì§€ë‹¹ 10ê°œì”© ë°˜í™˜
 
 
-# ğŸ“„ ì€í–‰ API
+# â”€â”€â”€ ì€í–‰ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 class BankViewSet(viewsets.ReadOnlyModelViewSet):
+    """
+    ì€í–‰ ëª©ë¡ ë° ìƒì„¸ ì¡°íšŒ
+    """
     queryset = Bank.objects.all()
     serializer_class = BankSerializer
     lookup_field = 'fin_co_no'
 
 
-# ğŸ“„ ì •ê¸°ì˜ˆê¸ˆ/ì ê¸ˆ API
+# â”€â”€â”€ ì˜ˆê¸ˆ/ì ê¸ˆ ìƒí’ˆ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 class DepositProductViewSet(viewsets.ModelViewSet):
-    permission_classes = [AllowAny]
-    queryset = DepositProduct.objects.all()
+    queryset = DepositProduct.objects.select_related('bank').prefetch_related('options')
     serializer_class = DepositProductSerializer
+    filter_backends = [filters.SearchFilter, filters.OrderingFilter]
+    search_fields = ['fin_prdt_nm', 'bank__kor_co_nm']
+    ordering_fields = ['dcls_strt_day', 'fin_prdt_nm']
 
-    @action(detail=False, methods=['get'], url_path='recommend')
-    def recommend(self, request):
-        top_n = int(request.query_params.get('top_n', 5))
-        min_term = request.query_params.get('min_term')
-        max_term = request.query_params.get('max_term')
+    @action(
+        detail=False, methods=['get'], url_path='recommend_by_profile',
+        authentication_classes=[TokenAuthentication],
+        permission_classes=[IsAuthenticated]
+    )
+    def recommend_by_profile(self, request):
+        asset_param = request.query_params.get('asset')
+        top_n       = int(request.query_params.get('top_n', 5))
+        if asset_param is None:
+            return Response({"error": "asset íŒŒë¼ë¯¸í„°ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."}, status=400)
+        try:
+            asset = float(asset_param)
+        except ValueError:
+            return Response({"error": "assetì€ ìˆ«ì í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤."}, status=400)
 
-        products = DepositProduct.objects.select_related('bank') \
-                                         .prefetch_related('options') \
-                                         .all()
+        bd = getattr(request.user, 'birth_date', None)
+        if not bd:
+            return Response({"error": "ìƒë…„ì›”ì¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."}, status=400)
+        today = date.today()
+        age   = today.year - bd.year - ((today.month, today.day) < (bd.month, bd.day))
 
+        four_banks     = ["êµ­ë¯¼ì€í–‰", "í•˜ë‚˜ì€í–‰", "ì‹ í•œì€í–‰", "ìš°ë¦¬ì€í–‰"]
+        TERM_THRESHOLD = 12
         recs = []
-        for prod in products:
+
+        for prod in self.queryset:
+            # 40ëŒ€ ì´ìƒì€ 4ëŒ€ ì€í–‰ë§Œ, ê·¸ë¦¬ê³  ë‹¨ê¸° ìƒí’ˆ(â‰¤12ê°œì›”)ë§Œ
+            if age >= 40:
+                if prod.bank.kor_co_nm not in four_banks:
+                    continue
+
             for opt in prod.options.all():
-                if not opt.save_trm or not opt.intr_rate:
+                if not opt.save_trm or opt.intr_rate is None:
                     continue
                 try:
                     term = int(opt.save_trm)
                     rate = float(opt.intr_rate)
                 except (TypeError, ValueError):
                     continue
-                if min_term and term < int(min_term):
-                    continue
-                if max_term and term > int(max_term):
-                    continue
-                annualized = rate * (12 / term)
+
+                # 20ëŒ€ ì´í•˜
+                if age <= 29:
+                    if asset > 100_000_000:
+                        # ì¥ê¸°ë§Œ(12ê°œì›” ì´ˆê³¼)
+                        if term <= TERM_THRESHOLD:
+                            continue
+                    else:
+                        # ë‹¨ê¸°ë§Œ(12ê°œì›” ì´í•˜)
+                        if term > TERM_THRESHOLD:
+                            continue
+
+                # 30ëŒ€ (30 â‰¤ age < 40)
+                elif age < 40:
+                    if asset > 150_000_000:
+                        if term <= TERM_THRESHOLD:
+                            continue
+                    else:
+                        if term > TERM_THRESHOLD:
+                            continue
+
+                # 40ëŒ€ ì´ìƒ(else ë¸”ë¡): ìœ„ì—ì„œ 4ëŒ€ ì€í–‰ë§Œ í•„í„°ë§ í–ˆìœ¼ë‹ˆ, ë‹¨ê¸°ë§Œ(12ê°œì›” ì´í•˜)
+                else:
+                    if term > TERM_THRESHOLD:
+                        continue
+
                 recs.append({
                     'fin_prdt_cd': prod.fin_prdt_cd,
                     'fin_prdt_nm': prod.fin_prdt_nm,
@@ -59,41 +109,15 @@ class DepositProductViewSet(viewsets.ModelViewSet):
                         'fin_co_no': prod.bank.fin_co_no,
                         'kor_co_nm': prod.bank.kor_co_nm,
                     },
-                    'option_id': opt.id,
-                    'save_trm': term,
-                    'intr_rate': rate,
-                    'annualized_rate': round(annualized, 4),
-                    'score': round(annualized, 4),
+                    'option_id':    opt.id,
+                    'save_trm':     term,
+                    'intr_rate':    rate,
                 })
 
-        top_recs = sorted(recs, key=lambda x: x['score'], reverse=True)[:top_n]
+        top_recs = sorted(recs, key=lambda x: x['intr_rate'], reverse=True)[:top_n]
         return Response(top_recs)
 
-    @action(detail=False, methods=['get'], url_path='sorted')
-    def sorted(self, request):
-        term = request.query_params.get('term')
-        product_type = request.query_params.get('type', 'saving')  # ê¸°ë³¸: ì ê¸ˆ
-    
-        if term is None:
-            return Response({"error": "term query param is required"}, status=400)
-    
-        rate_subquery = InterestOption.objects.filter(
-            product=OuterRef('pk'),
-            save_trm=term,
-            intr_rate__isnull=False
-        ).order_by('-intr_rate').values('intr_rate')[:1]
-    
-        products = DepositProduct.objects.filter(product_type=product_type) \
-            .annotate(top_rate=Subquery(rate_subquery, output_field=FloatField())) \
-            .filter(top_rate__isnull=False) \
-            .order_by('-top_rate') \
-            .prefetch_related('options', 'bank')
-    
-        serializer = self.get_serializer(products, many=True)
-        return Response(serializer.data)
-
-
-# ğŸ“„ ê¸ˆë¦¬ ì˜µì…˜ API
+# â”€â”€â”€ ê¸ˆë¦¬ ì˜µì…˜ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 class InterestOptionViewSet(viewsets.ReadOnlyModelViewSet):
     queryset = InterestOption.objects.select_related('product')
     serializer_class = InterestOptionSerializer
